<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>TwoRayGensSubgraph</title>
        <link rel="stylesheet" href="../../../style.css">
        <script type="module">
            import { test_RayTrace_TwoRayGensSubgraph } from "../../../UnitTestLogic.js";


            const VK_SHIFT = 0x10;
            const VK_CONTROL = 0x11;
            const VK_UP = 0x26;
            const VK_DOWN = 0x28;
            const VK_LEFT = 0x25;
            const VK_RIGHT = 0x27;
            const VK_PRIOR = 0x21;
            const VK_NEXT = 0x22;

            const VK_W = 87;
            const VK_A = 65;
            const VK_S = 83;
            const VK_D = 68;
            const VK_E = 69;
            const VK_Q = 81;

            const VK_w = 87 + 32;
            const VK_a = 65 + 32;
            const VK_s = 83 + 32;
            const VK_d = 68 + 32;
            const VK_e = 69 + 32;
            const VK_q = 81 + 32;

            // Handle collapsible variable tables
            var coll = document.getElementsByClassName("collapsible");
            for (let i = 0; i < coll.length; i++)
            {
                coll[i].addEventListener("click", function ()
                {
                    this.classList.toggle("active");
                    var content = this.nextElementSibling;
                    if (content.style.display === "block")
                        content.style.display = "none";
                    else
                        content.style.display = "block";
                });
            }

            // Handle viewing texture drop down
            let viewingTextureName = "Texture";
            document.getElementById("Viewing").addEventListener('change', (event) => { if (event.target.value.length != 0) viewingTextureName = event.target.value; });

            function parseUint(value)
            {
                value = parseInt(value);
                if (value < 0)
                    value = 0;
                return value;
            }

            let CameraPos = [ 0, 0, -10 ];
            let CameraAltitudeAzimuth = [ 0, 0 ];
            let CameraLeftHanded = true;
            let CameraFlySpeed = 0.1;
            let CameraMouseSensitivity = 0.01;
            let CameraChanged = false;

            let CameraPos_Starting = [ 0, 0, -10 ];
            let CameraAltitudeAzimuth_Starting = [ 0, 0 ];

            SetCameraUIToCamera();

            function ResetCamera()
            {
                CameraPos = CameraPos_Starting.slice();
                CameraAltitudeAzimuth = CameraAltitudeAzimuth_Starting.slice();
                SetCameraUIToCamera();
            }
            document.getElementById('ResetCamera').addEventListener('click', (event) => { ResetCamera(); });

            document.getElementById("CameraPos0").addEventListener('change', (event) => { CameraPos[0] = event.target.value; });
            document.getElementById("CameraPos1").addEventListener('change', (event) => { CameraPos[1] = event.target.value; });
            document.getElementById("CameraPos2").addEventListener('change', (event) => { CameraPos[2] = event.target.value; });
            document.getElementById("CameraAltitudeAzimuth0").addEventListener('change', (event) => { CameraAltitudeAzimuth[0] = event.target.value; });
            document.getElementById("CameraAltitudeAzimuth1").addEventListener('change', (event) => { CameraAltitudeAzimuth[1] = event.target.value; });

            // Camera mouse sensitivity and fly speed
            document.getElementById("CameraMouseSensitivity").value = 0.01;
            document.getElementById("CameraFlySpeed").value = 0.1;
            document.getElementById("CameraMouseSensitivity").addEventListener('change', (event) => { CameraMouseSensitivity = event.target.value; });
            document.getElementById("CameraFlySpeed").addEventListener('change', (event) => { CameraFlySpeed = event.target.value; });

            function SetCameraUIToCamera()
            {
                document.getElementById("CameraPos0").value = CameraPos[0];
                document.getElementById("CameraPos1").value = CameraPos[1];
                document.getElementById("CameraPos2").value = CameraPos[2];

                document.getElementById("CameraAltitudeAzimuth0").value = CameraAltitudeAzimuth[0];
                document.getElementById("CameraAltitudeAzimuth1").value = CameraAltitudeAzimuth[1];
            }

            function UpdateCamera(frameTimeSeconds)
            {
                CameraChanged = false;

                // To account for frame time
                const movementMultiplier = frameTimeSeconds * 60.0;

                // If the mouse is dragging, rotate the camera
                if (MouseState[2] && MouseStateLastFrame[2])
                {
                    let dx = MouseStateLastFrame[0] - MouseState[0];
                    let dy = MouseStateLastFrame[1] - MouseState[1];

                    dx *= movementMultiplier;
                    dy *= movementMultiplier;

                    if (!CameraLeftHanded)
                    {
                        dx *= -1.0;
                        dy *= -1.0;
                    }

                    CameraAltitudeAzimuth[0] += dy * CameraMouseSensitivity;
                    CameraAltitudeAzimuth[0] = Math.max(Math.min(CameraAltitudeAzimuth[0], Math.PI * 0.49), -Math.PI * 0.49);

                    CameraAltitudeAzimuth[1] += dx * CameraMouseSensitivity;
                    if (CameraAltitudeAzimuth[1] < 0.0)
                        CameraAltitudeAzimuth[1] += 2.0 * Math.PI;
                    CameraAltitudeAzimuth[1] = CameraAltitudeAzimuth[1] % (2.0 * Math.PI);

                    if (dx != 0.0 || dy != 0.0)
                        CameraChanged = true;
                }

                // Handle WASD
                {
                    const viewMatrix = Shared.GetViewMatrix(CameraPos, CameraAltitudeAzimuth);

                    const left = [ viewMatrix[0], viewMatrix[4], viewMatrix[8] ];
                    const up   = [ viewMatrix[1], viewMatrix[5], viewMatrix[9] ];
                    const fwd  = [ viewMatrix[2], viewMatrix[6], viewMatrix[10] ];

                    let flySpeed = CameraFlySpeed * movementMultiplier;

                    if (KeyStates[VK_SHIFT])
                        flySpeed *= 10.0;
                    else if (KeyStates[VK_CONTROL])
                        flySpeed /= 10.0;

                    if (!CameraLeftHanded)
                    {
                        fwd[0] *= -1.0;
                        fwd[1] *= -1.0;
                        fwd[2] *= -1.0;
                    }

                    if (KeyStates[VK_W] || KeyStates[VK_w] || KeyStates[VK_UP])
                    {
                        CameraPos[0] += fwd[0] * flySpeed;
                        CameraPos[1] += fwd[1] * flySpeed;
                        CameraPos[2] += fwd[2] * flySpeed;
                        CameraChanged = true;
                    }

                    if (KeyStates[VK_S] || KeyStates[VK_s] || KeyStates[VK_DOWN])
                    {
                        CameraPos[0] -= fwd[0] * flySpeed;
                        CameraPos[1] -= fwd[1] * flySpeed;
                        CameraPos[2] -= fwd[2] * flySpeed;
                        CameraChanged = true;
                    }

                    if (KeyStates[VK_A] || KeyStates[VK_a] || KeyStates[VK_LEFT])
                    {
                        CameraPos[0] -= left[0] * flySpeed;
                        CameraPos[1] -= left[1] * flySpeed;
                        CameraPos[2] -= left[2] * flySpeed;
                        CameraChanged = true;
                    }

                    if (KeyStates[VK_D] || KeyStates[VK_d] || KeyStates[VK_RIGHT])
                    {
                        CameraPos[0] += left[0] * flySpeed;
                        CameraPos[1] += left[1] * flySpeed;
                        CameraPos[2] += left[2] * flySpeed;
                        CameraChanged = true;
                    }

                    if (KeyStates[VK_E] || KeyStates[VK_e] || KeyStates[VK_PRIOR])
                    {
                        CameraPos[0] += up[0] * flySpeed;
                        CameraPos[1] += up[1] * flySpeed;
                        CameraPos[2] += up[2] * flySpeed;
                        CameraChanged = true;
                    }

                    if (KeyStates[VK_Q] || KeyStates[VK_q] || KeyStates[VK_NEXT])
                    {
                        CameraPos[0] -= up[0] * flySpeed;
                        CameraPos[1] -= up[1] * flySpeed;
                        CameraPos[2] -= up[2] * flySpeed;
                        CameraChanged = true;
                    }
                }

                if (CameraChanged)
                    SetCameraUIToCamera();
            }

            // Import the technique
            import TwoRayGensSubgraph from "./TwoRayGensSubgraph_Module.js"
            import * as Shared from '../../../Shared.js';

            // Initialize WebGPU
            const canvas = document.getElementById('mainCanvas');
            if (!navigator.gpu)
            {
                alert("WebGPU not supported on this browser.");
                throw new Error("WebGPU not supported on this browser.");
            }

            const adapter = await navigator.gpu.requestAdapter();
            if (!adapter)
            {
                alert("No appropriate GPUAdapter found.");
                throw new Error("No appropriate GPUAdapter found.");
            }

            const device = await adapter.requestDevice({
                requiredLimits: {  },
                requiredFeatures: [  ],
            });

            const context = canvas.getContext("webgpu");
            //const canvasFormat = navigator.gpu.getPreferredCanvasFormat();
            const canvasFormat = "rgba8unorm";
            context.configure({
                device: device,
                format: canvasFormat,
                usage: GPUTextureUsage.COPY_DST | GPUTextureUsage.STORAGE_BINDING,
            });

            // Setup canvas events
            let iMouse = [0, 0, 0, 0];
            let MouseState = [0, 0, 0, 0];
            let MouseStateLastFrame = [0, 0, 0, 0];
            let KeyStates = Array(256).fill(0);
            let KeyStatesLastFrame = Array(256).fill(0);
            canvas.addEventListener('click', (event) => { if (event.button == 0) { iMouse[0] = event.offsetX; iMouse[1] = event.offsetY; iMouse[2] = iMouse[0]; iMouse[3] = iMouse[1]; } });
            canvas.addEventListener('mousemove', (event) => { MouseState[0] = event.offsetX; MouseState[1] = event.offsetY; });
            canvas.addEventListener('mousedown', (event) => { if (event.button == 0) { MouseState[2] = 1 } else if (event.button == 2) { MouseState[3] = 1 } });
            canvas.addEventListener('mouseup', (event) => { if (event.button == 0) { MouseState[2] = 0 } else if (event.button == 2) { MouseState[3] = 0 } });
            canvas.addEventListener('keydown', (event) => { KeyStates[event.keyCode] = 1; });
            canvas.addEventListener('keyup', (event) => { KeyStates[event.keyCode] = 0; });

            // Hook up the on change events for imported resources
            document.getElementById('importedResourceURL_BlueChannel').addEventListener('change', async (event) =>
                {
                    if (typeof TwoRayGensSubgraph.importedResourceURL_BlueChannel === 'undefined' || TwoRayGensSubgraph.importedResourceURL_BlueChannel != event.target.value)
                    {
                        TwoRayGensSubgraph.importedResourceURL_BlueChannel = event.target.value;
                        const loadedTexture = await Shared.CreateTextureWithPNG(device, event.target.value, TwoRayGensSubgraph.texture_BlueChannel_usageFlags);
                        if (loadedTexture !== null)
                        {
                            TwoRayGensSubgraph.texture_BlueChannel = loadedTexture.texture;
                            TwoRayGensSubgraph.texture_BlueChannel_size = loadedTexture.size;
                            TwoRayGensSubgraph.texture_BlueChannel_format = loadedTexture.format;
                        }
                    }
                }
            );

            // Hook up the on change events for UI
            document.getElementById('inputBox_clipToWorld0').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[0]=event.target.value;});
            document.getElementById('inputBox_clipToWorld1').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[1]=event.target.value;});
            document.getElementById('inputBox_clipToWorld2').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[2]=event.target.value;});
            document.getElementById('inputBox_clipToWorld3').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[3]=event.target.value;});
            document.getElementById('inputBox_clipToWorld4').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[4]=event.target.value;});
            document.getElementById('inputBox_clipToWorld5').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[5]=event.target.value;});
            document.getElementById('inputBox_clipToWorld6').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[6]=event.target.value;});
            document.getElementById('inputBox_clipToWorld7').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[7]=event.target.value;});
            document.getElementById('inputBox_clipToWorld8').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[8]=event.target.value;});
            document.getElementById('inputBox_clipToWorld9').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[9]=event.target.value;});
            document.getElementById('inputBox_clipToWorld10').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[10]=event.target.value;});
            document.getElementById('inputBox_clipToWorld11').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[11]=event.target.value;});
            document.getElementById('inputBox_clipToWorld12').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[12]=event.target.value;});
            document.getElementById('inputBox_clipToWorld13').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[13]=event.target.value;});
            document.getElementById('inputBox_clipToWorld14').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[14]=event.target.value;});
            document.getElementById('inputBox_clipToWorld15').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_clipToWorld[15]=event.target.value;});
            document.getElementById('inputBox_cameraPos0').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_cameraPos[0]=event.target.value;});
            document.getElementById('inputBox_cameraPos1').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_cameraPos[1]=event.target.value;});
            document.getElementById('inputBox_cameraPos2').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_cameraPos[2]=event.target.value;});
            document.getElementById('inputBox_depthNearPlane').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_depthNearPlane=event.target.value;});
            document.getElementById('inputBox_hitColor0').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_hitColor[0]=event.target.value;});
            document.getElementById('inputBox_hitColor1').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_hitColor[1]=event.target.value;});
            document.getElementById('inputBox_hitColor2').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_hitColor[2]=event.target.value;});
            document.getElementById('inputBox_missColor0').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_missColor[0]=event.target.value;});
            document.getElementById('inputBox_missColor1').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_missColor[1]=event.target.value;});
            document.getElementById('inputBox_missColor2').addEventListener('change',(event) => {event.target.value=parseFloat(event.target.value); TwoRayGensSubgraph.variable_missColor[2]=event.target.value;});
            document.getElementById('inputBox__dispatchSize_A_TwoRayGens10').addEventListener('change',(event) => {event.target.value=parseUint(event.target.value); TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[0]=event.target.value;});
            document.getElementById('inputBox__dispatchSize_A_TwoRayGens11').addEventListener('change',(event) => {event.target.value=parseUint(event.target.value); TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[1]=event.target.value;});
            document.getElementById('inputBox__dispatchSize_A_TwoRayGens12').addEventListener('change',(event) => {event.target.value=parseUint(event.target.value); TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[2]=event.target.value;});
            document.getElementById('inputBox__dispatchSize_B_TwoRayGens20').addEventListener('change',(event) => {event.target.value=parseUint(event.target.value); TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[0]=event.target.value;});
            document.getElementById('inputBox__dispatchSize_B_TwoRayGens21').addEventListener('change',(event) => {event.target.value=parseUint(event.target.value); TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[1]=event.target.value;});
            document.getElementById('inputBox__dispatchSize_B_TwoRayGens22').addEventListener('change',(event) => {event.target.value=parseUint(event.target.value); TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[2]=event.target.value;});

            function ResetVariables()
            {
                    TwoRayGensSubgraph.variable_clipToWorld[0] = TwoRayGensSubgraph.variableDefault_clipToWorld[0];
                    TwoRayGensSubgraph.variable_clipToWorld[1] = TwoRayGensSubgraph.variableDefault_clipToWorld[1];
                    TwoRayGensSubgraph.variable_clipToWorld[2] = TwoRayGensSubgraph.variableDefault_clipToWorld[2];
                    TwoRayGensSubgraph.variable_clipToWorld[3] = TwoRayGensSubgraph.variableDefault_clipToWorld[3];
                    TwoRayGensSubgraph.variable_clipToWorld[4] = TwoRayGensSubgraph.variableDefault_clipToWorld[4];
                    TwoRayGensSubgraph.variable_clipToWorld[5] = TwoRayGensSubgraph.variableDefault_clipToWorld[5];
                    TwoRayGensSubgraph.variable_clipToWorld[6] = TwoRayGensSubgraph.variableDefault_clipToWorld[6];
                    TwoRayGensSubgraph.variable_clipToWorld[7] = TwoRayGensSubgraph.variableDefault_clipToWorld[7];
                    TwoRayGensSubgraph.variable_clipToWorld[8] = TwoRayGensSubgraph.variableDefault_clipToWorld[8];
                    TwoRayGensSubgraph.variable_clipToWorld[9] = TwoRayGensSubgraph.variableDefault_clipToWorld[9];
                    TwoRayGensSubgraph.variable_clipToWorld[10] = TwoRayGensSubgraph.variableDefault_clipToWorld[10];
                    TwoRayGensSubgraph.variable_clipToWorld[11] = TwoRayGensSubgraph.variableDefault_clipToWorld[11];
                    TwoRayGensSubgraph.variable_clipToWorld[12] = TwoRayGensSubgraph.variableDefault_clipToWorld[12];
                    TwoRayGensSubgraph.variable_clipToWorld[13] = TwoRayGensSubgraph.variableDefault_clipToWorld[13];
                    TwoRayGensSubgraph.variable_clipToWorld[14] = TwoRayGensSubgraph.variableDefault_clipToWorld[14];
                    TwoRayGensSubgraph.variable_clipToWorld[15] = TwoRayGensSubgraph.variableDefault_clipToWorld[15];
                    TwoRayGensSubgraph.variable_cameraPos[0] = TwoRayGensSubgraph.variableDefault_cameraPos[0];
                    TwoRayGensSubgraph.variable_cameraPos[1] = TwoRayGensSubgraph.variableDefault_cameraPos[1];
                    TwoRayGensSubgraph.variable_cameraPos[2] = TwoRayGensSubgraph.variableDefault_cameraPos[2];
                    TwoRayGensSubgraph.variable_depthNearPlane = TwoRayGensSubgraph.variableDefault_depthNearPlane;
                    TwoRayGensSubgraph.variable_hitColor[0] = TwoRayGensSubgraph.variableDefault_hitColor[0];
                    TwoRayGensSubgraph.variable_hitColor[1] = TwoRayGensSubgraph.variableDefault_hitColor[1];
                    TwoRayGensSubgraph.variable_hitColor[2] = TwoRayGensSubgraph.variableDefault_hitColor[2];
                    TwoRayGensSubgraph.variable_missColor[0] = TwoRayGensSubgraph.variableDefault_missColor[0];
                    TwoRayGensSubgraph.variable_missColor[1] = TwoRayGensSubgraph.variableDefault_missColor[1];
                    TwoRayGensSubgraph.variable_missColor[2] = TwoRayGensSubgraph.variableDefault_missColor[2];
                    TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[0] = TwoRayGensSubgraph.variableDefault__dispatchSize_A_TwoRayGens1[0];
                    TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[1] = TwoRayGensSubgraph.variableDefault__dispatchSize_A_TwoRayGens1[1];
                    TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[2] = TwoRayGensSubgraph.variableDefault__dispatchSize_A_TwoRayGens1[2];
                    TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[0] = TwoRayGensSubgraph.variableDefault__dispatchSize_B_TwoRayGens2[0];
                    TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[1] = TwoRayGensSubgraph.variableDefault__dispatchSize_B_TwoRayGens2[1];
                    TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[2] = TwoRayGensSubgraph.variableDefault__dispatchSize_B_TwoRayGens2[2];
            }

            function SetUIToVariables()
            {
                    document.getElementById('inputBox_clipToWorld0').value = TwoRayGensSubgraph.variable_clipToWorld[0];
                    document.getElementById('inputBox_clipToWorld1').value = TwoRayGensSubgraph.variable_clipToWorld[1];
                    document.getElementById('inputBox_clipToWorld2').value = TwoRayGensSubgraph.variable_clipToWorld[2];
                    document.getElementById('inputBox_clipToWorld3').value = TwoRayGensSubgraph.variable_clipToWorld[3];
                    document.getElementById('inputBox_clipToWorld4').value = TwoRayGensSubgraph.variable_clipToWorld[4];
                    document.getElementById('inputBox_clipToWorld5').value = TwoRayGensSubgraph.variable_clipToWorld[5];
                    document.getElementById('inputBox_clipToWorld6').value = TwoRayGensSubgraph.variable_clipToWorld[6];
                    document.getElementById('inputBox_clipToWorld7').value = TwoRayGensSubgraph.variable_clipToWorld[7];
                    document.getElementById('inputBox_clipToWorld8').value = TwoRayGensSubgraph.variable_clipToWorld[8];
                    document.getElementById('inputBox_clipToWorld9').value = TwoRayGensSubgraph.variable_clipToWorld[9];
                    document.getElementById('inputBox_clipToWorld10').value = TwoRayGensSubgraph.variable_clipToWorld[10];
                    document.getElementById('inputBox_clipToWorld11').value = TwoRayGensSubgraph.variable_clipToWorld[11];
                    document.getElementById('inputBox_clipToWorld12').value = TwoRayGensSubgraph.variable_clipToWorld[12];
                    document.getElementById('inputBox_clipToWorld13').value = TwoRayGensSubgraph.variable_clipToWorld[13];
                    document.getElementById('inputBox_clipToWorld14').value = TwoRayGensSubgraph.variable_clipToWorld[14];
                    document.getElementById('inputBox_clipToWorld15').value = TwoRayGensSubgraph.variable_clipToWorld[15];
                    document.getElementById('inputBox_cameraPos0').value = TwoRayGensSubgraph.variable_cameraPos[0];
                    document.getElementById('inputBox_cameraPos1').value = TwoRayGensSubgraph.variable_cameraPos[1];
                    document.getElementById('inputBox_cameraPos2').value = TwoRayGensSubgraph.variable_cameraPos[2];
                    document.getElementById('inputBox_depthNearPlane').value = TwoRayGensSubgraph.variable_depthNearPlane;
                    document.getElementById('inputBox_hitColor0').value = TwoRayGensSubgraph.variable_hitColor[0];
                    document.getElementById('inputBox_hitColor1').value = TwoRayGensSubgraph.variable_hitColor[1];
                    document.getElementById('inputBox_hitColor2').value = TwoRayGensSubgraph.variable_hitColor[2];
                    document.getElementById('inputBox_missColor0').value = TwoRayGensSubgraph.variable_missColor[0];
                    document.getElementById('inputBox_missColor1').value = TwoRayGensSubgraph.variable_missColor[1];
                    document.getElementById('inputBox_missColor2').value = TwoRayGensSubgraph.variable_missColor[2];
                    document.getElementById('inputBox__dispatchSize_A_TwoRayGens10').value = TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[0];
                    document.getElementById('inputBox__dispatchSize_A_TwoRayGens11').value = TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[1];
                    document.getElementById('inputBox__dispatchSize_A_TwoRayGens12').value = TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[2];
                    document.getElementById('inputBox__dispatchSize_B_TwoRayGens20').value = TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[0];
                    document.getElementById('inputBox__dispatchSize_B_TwoRayGens21').value = TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[1];
                    document.getElementById('inputBox__dispatchSize_B_TwoRayGens22').value = TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[2];
            }

            // Set variables to their defaults
            ResetVariables();

            document.getElementById('ResetVariables').addEventListener('click',(event) => { ResetVariables(); SetUIToVariables(); });

            // Initialize the technique from unit test logic
            await test_RayTrace_TwoRayGensSubgraph.Init(device, TwoRayGensSubgraph);

            // Set variables to what they were saved as in the gguser file
            TwoRayGensSubgraph.variable_depthNearPlane = 0.000000;
            TwoRayGensSubgraph.variable_hitColor = [0.000000,1.000000,0.000000];
            TwoRayGensSubgraph.variable_missColor = [1.000000,0.000000,0.000000];

            // Make sure the UI shows the correct variable values
            SetUIToVariables();

            // Frame rendering function
            let startTimeMs;
            let lastTimeMs;
            let frameIndex = 0
            async function RenderFrame(currentTimeMs) {

                // Don't run the technique if any imported resources are missing
                if ( TwoRayGensSubgraph.texture_BlueChannel === null )
                {
                    requestAnimationFrame(RenderFrame);
                    return;
                }

                // Handle frame timing
                if (startTimeMs === undefined)
                {
                    startTimeMs = currentTimeMs;
                    lastTimeMs = currentTimeMs;
                }

                // Show FPS
                document.getElementById("FPS").innerHTML = "<br><br>FPS: " + (1000.0 / (currentTimeMs - lastTimeMs)).toFixed(2) + "<br>ms: " + (currentTimeMs - lastTimeMs).toFixed(2);

                // Update the camera based on user input
                UpdateCamera((currentTimeMs - lastTimeMs) / 1000);

                // Run the technique
                const encoder = device.createCommandEncoder();

                // Do pre execute unit test logic
                test_RayTrace_TwoRayGensSubgraph.PreExecute(device, encoder, TwoRayGensSubgraph, frameIndex);

                // Projection matrix resolution texture
                const projMtxResolution = [ TwoRayGensSubgraph.texture_Texture_size[0], TwoRayGensSubgraph.texture_Texture_size[1] ];

                // Inverse View Proj matrix
                {
                    const viewMtx = Shared.GetInvViewMatrix(CameraPos, CameraAltitudeAzimuth);
                    const projMtx = Shared.GetInvProjMatrix(45, projMtxResolution, 0.1, 1000, true, true, CameraLeftHanded);
                    TwoRayGensSubgraph.variable_clipToWorld = Shared.MatMul(projMtx, viewMtx);
                    TwoRayGensSubgraph.variableChanged_clipToWorld = new Array(16).fill(true);
                }

                // Camera Position
                TwoRayGensSubgraph.variable_cameraPos = CameraPos.slice();
                TwoRayGensSubgraph.variableChanged_cameraPos = new Array(3).fill(true);

                const executeResult = await TwoRayGensSubgraph.Execute(device, encoder, false);
                if (!executeResult)
                {
                    alert("Could not execute TwoRayGensSubgraph");
                    throw new Error("Could not execute TwoRayGensSubgraph");
                }

                if (viewingTextureName.length != 0 && TwoRayGensSubgraph["texture_" + viewingTextureName] !== null)
                {
                    // Update size of the canvas
                    document.getElementById("mainCanvas").width = TwoRayGensSubgraph["texture_" + viewingTextureName].width;
                    document.getElementById("mainCanvas").height = TwoRayGensSubgraph["texture_" + viewingTextureName].height;

                    if (!Shared.CopyCompatibleFormats(TwoRayGensSubgraph["texture_" + viewingTextureName].format, canvasFormat))
                    {
                        Shared.CopyTextureLinearToSRGB(device, encoder, TwoRayGensSubgraph["texture_" + viewingTextureName], context.getCurrentTexture());
                    }
                    else
                    {
                        encoder.copyTextureToTexture(
                            { texture: TwoRayGensSubgraph["texture_" + viewingTextureName] },
                            { texture: context.getCurrentTexture() },
                            {
                                width: Math.min(TwoRayGensSubgraph["texture_" + viewingTextureName].width, context.getCurrentTexture().width),
                                height: Math.min(TwoRayGensSubgraph["texture_" + viewingTextureName].height, context.getCurrentTexture().height),
                                depthOrArrayLayers: Math.min(TwoRayGensSubgraph["texture_" + viewingTextureName].depthOrArrayLayers, context.getCurrentTexture().depthOrArrayLayers)
                            }
                        );
                    }
                }

                // If the technique changed the variables, update the UI
                if (TwoRayGensSubgraph.variableChanged_clipToWorld[0])
                {
                    document.getElementById('inputBox_clipToWorld0').value = TwoRayGensSubgraph.variable_clipToWorld[0];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[0] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[1])
                {
                    document.getElementById('inputBox_clipToWorld1').value = TwoRayGensSubgraph.variable_clipToWorld[1];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[1] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[2])
                {
                    document.getElementById('inputBox_clipToWorld2').value = TwoRayGensSubgraph.variable_clipToWorld[2];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[2] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[3])
                {
                    document.getElementById('inputBox_clipToWorld3').value = TwoRayGensSubgraph.variable_clipToWorld[3];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[3] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[4])
                {
                    document.getElementById('inputBox_clipToWorld4').value = TwoRayGensSubgraph.variable_clipToWorld[4];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[4] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[5])
                {
                    document.getElementById('inputBox_clipToWorld5').value = TwoRayGensSubgraph.variable_clipToWorld[5];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[5] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[6])
                {
                    document.getElementById('inputBox_clipToWorld6').value = TwoRayGensSubgraph.variable_clipToWorld[6];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[6] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[7])
                {
                    document.getElementById('inputBox_clipToWorld7').value = TwoRayGensSubgraph.variable_clipToWorld[7];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[7] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[8])
                {
                    document.getElementById('inputBox_clipToWorld8').value = TwoRayGensSubgraph.variable_clipToWorld[8];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[8] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[9])
                {
                    document.getElementById('inputBox_clipToWorld9').value = TwoRayGensSubgraph.variable_clipToWorld[9];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[9] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[10])
                {
                    document.getElementById('inputBox_clipToWorld10').value = TwoRayGensSubgraph.variable_clipToWorld[10];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[10] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[11])
                {
                    document.getElementById('inputBox_clipToWorld11').value = TwoRayGensSubgraph.variable_clipToWorld[11];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[11] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[12])
                {
                    document.getElementById('inputBox_clipToWorld12').value = TwoRayGensSubgraph.variable_clipToWorld[12];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[12] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[13])
                {
                    document.getElementById('inputBox_clipToWorld13').value = TwoRayGensSubgraph.variable_clipToWorld[13];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[13] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[14])
                {
                    document.getElementById('inputBox_clipToWorld14').value = TwoRayGensSubgraph.variable_clipToWorld[14];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[14] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_clipToWorld[15])
                {
                    document.getElementById('inputBox_clipToWorld15').value = TwoRayGensSubgraph.variable_clipToWorld[15];
                    TwoRayGensSubgraph.variableChanged_clipToWorld[15] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_cameraPos[0])
                {
                    document.getElementById('inputBox_cameraPos0').value = TwoRayGensSubgraph.variable_cameraPos[0];
                    TwoRayGensSubgraph.variableChanged_cameraPos[0] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_cameraPos[1])
                {
                    document.getElementById('inputBox_cameraPos1').value = TwoRayGensSubgraph.variable_cameraPos[1];
                    TwoRayGensSubgraph.variableChanged_cameraPos[1] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_cameraPos[2])
                {
                    document.getElementById('inputBox_cameraPos2').value = TwoRayGensSubgraph.variable_cameraPos[2];
                    TwoRayGensSubgraph.variableChanged_cameraPos[2] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_depthNearPlane)
                {
                    document.getElementById('inputBox_depthNearPlane').value = TwoRayGensSubgraph.variable_depthNearPlane;
                    TwoRayGensSubgraph.variableChanged_depthNearPlane = false;
                }

                if (TwoRayGensSubgraph.variableChanged_hitColor[0])
                {
                    document.getElementById('inputBox_hitColor0').value = TwoRayGensSubgraph.variable_hitColor[0];
                    TwoRayGensSubgraph.variableChanged_hitColor[0] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_hitColor[1])
                {
                    document.getElementById('inputBox_hitColor1').value = TwoRayGensSubgraph.variable_hitColor[1];
                    TwoRayGensSubgraph.variableChanged_hitColor[1] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_hitColor[2])
                {
                    document.getElementById('inputBox_hitColor2').value = TwoRayGensSubgraph.variable_hitColor[2];
                    TwoRayGensSubgraph.variableChanged_hitColor[2] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_missColor[0])
                {
                    document.getElementById('inputBox_missColor0').value = TwoRayGensSubgraph.variable_missColor[0];
                    TwoRayGensSubgraph.variableChanged_missColor[0] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_missColor[1])
                {
                    document.getElementById('inputBox_missColor1').value = TwoRayGensSubgraph.variable_missColor[1];
                    TwoRayGensSubgraph.variableChanged_missColor[1] = false;
                }

                if (TwoRayGensSubgraph.variableChanged_missColor[2])
                {
                    document.getElementById('inputBox_missColor2').value = TwoRayGensSubgraph.variable_missColor[2];
                    TwoRayGensSubgraph.variableChanged_missColor[2] = false;
                }

                if (TwoRayGensSubgraph.variableChanged__dispatchSize_A_TwoRayGens1[0])
                {
                    document.getElementById('inputBox__dispatchSize_A_TwoRayGens10').value = TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[0];
                    TwoRayGensSubgraph.variableChanged__dispatchSize_A_TwoRayGens1[0] = false;
                }

                if (TwoRayGensSubgraph.variableChanged__dispatchSize_A_TwoRayGens1[1])
                {
                    document.getElementById('inputBox__dispatchSize_A_TwoRayGens11').value = TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[1];
                    TwoRayGensSubgraph.variableChanged__dispatchSize_A_TwoRayGens1[1] = false;
                }

                if (TwoRayGensSubgraph.variableChanged__dispatchSize_A_TwoRayGens1[2])
                {
                    document.getElementById('inputBox__dispatchSize_A_TwoRayGens12').value = TwoRayGensSubgraph.variable__dispatchSize_A_TwoRayGens1[2];
                    TwoRayGensSubgraph.variableChanged__dispatchSize_A_TwoRayGens1[2] = false;
                }

                if (TwoRayGensSubgraph.variableChanged__dispatchSize_B_TwoRayGens2[0])
                {
                    document.getElementById('inputBox__dispatchSize_B_TwoRayGens20').value = TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[0];
                    TwoRayGensSubgraph.variableChanged__dispatchSize_B_TwoRayGens2[0] = false;
                }

                if (TwoRayGensSubgraph.variableChanged__dispatchSize_B_TwoRayGens2[1])
                {
                    document.getElementById('inputBox__dispatchSize_B_TwoRayGens21').value = TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[1];
                    TwoRayGensSubgraph.variableChanged__dispatchSize_B_TwoRayGens2[1] = false;
                }

                if (TwoRayGensSubgraph.variableChanged__dispatchSize_B_TwoRayGens2[2])
                {
                    document.getElementById('inputBox__dispatchSize_B_TwoRayGens22').value = TwoRayGensSubgraph.variable__dispatchSize_B_TwoRayGens2[2];
                    TwoRayGensSubgraph.variableChanged__dispatchSize_B_TwoRayGens2[2] = false;
                }


                // Submit the command encoder
                device.queue.submit([encoder.finish()]);

                // advance to the next frame
                lastTimeMs = currentTimeMs;

                // Only do end of frame logic if we should.
                // If we are waiting on promises (shader compiles), Execute()
                // has frame start logic, but is waiting to do frame end logic, so we should too.
                if (!TwoRayGensSubgraph.waitingOnPromises)
                {
                    frameIndex = frameIndex + 1;

                    // Update mouse states
                    iMouse[2] = 0;
                    iMouse[3] = 0;
                    MouseStateLastFrame = MouseState.slice();

                    // Update keyboard states
                    KeyStatesLastFrame = KeyStates.slice();
                }

                // Update the loading list
                let loadingText = "";
                if (TwoRayGensSubgraph.loadingPromises.size > 0)
                    loadingText = "Nodes building shaders:";
                for (const label of TwoRayGensSubgraph.loadingPromises)
                    loadingText = loadingText + "<br/>" + label;
                document.getElementById("LoadingText").innerHTML = loadingText;

                // Render the next frame
                requestAnimationFrame(RenderFrame);
            }

            // Render the first frame
            requestAnimationFrame(RenderFrame);
        </script>
    </head>
    <body>
        <table>
            <tr>
                <td valign="top">
                    <a href="/index.html">Index</a>
                    <a href="/UnitTests\RayTrace\TwoRayGens\index.html"> << </a>
                    32 / 50
                    <a href="/UnitTests\SubGraph\ConstOverride\index.html"> >> </a><br/>
                    <canvas width="512" height="512" id="mainCanvas" tabindex="0"></canvas>
                    <br/><br/>
                    <label for="Viewing">Viewing</label>
                    <select name="Viewing" id="Viewing">
                        <option value="Texture">Texture</option><br/>
                        <option value="">----- Exported Textures -----</option><br/>
                        <option value="Texture">Texture</option><br/>
                        <option value="">----- Imported Textures -----</option><br/>
                        <option value="BlueChannel">BlueChannel</option><br/>
                        <option value="">----- Internal Textures -----</option><br/>
                        <option value="A_DoRT1_g_texture_ReadOnly">A_DoRT1_g_texture_ReadOnly</option><br/>
                        <option value="B_DoRT2_g_texture_ReadOnly">B_DoRT2_g_texture_ReadOnly</option><br/>
                    </select>
                </td>
                <td>&nbsp;</td>
                <td valign="top">
                    <b>TwoRayGensSubgraph</b><br/>
                    <button type="button" class="collapsible">User Variables</button>
                    <table cellspacing="0" cellpadding="0" class="collapsiblecontent" style="display:block">
                        <tr>
                            <td valign="top">hitColor&nbsp;</td>
                            <td>
                                <input type="text" id="inputBox_hitColor0">
                                <input type="text" id="inputBox_hitColor1">
                                <input type="text" id="inputBox_hitColor2">
                            </td>
                        </tr>
                        <tr>
                            <td valign="top">missColor&nbsp;</td>
                            <td>
                                <input type="text" id="inputBox_missColor0">
                                <input type="text" id="inputBox_missColor1">
                                <input type="text" id="inputBox_missColor2">
                            </td>
                        </tr>
                    </table>
                    <br><br>
                    <button type="button" class="collapsible">Host Variables</button>
                    <table cellspacing="0" cellpadding="0" class="collapsiblecontent" style="display:none">
                        <tr>
                            <td valign="top">clipToWorld&nbsp;</td>
                            <td>
                                <input type="text" id="inputBox_clipToWorld0">
                                <input type="text" id="inputBox_clipToWorld1">
                                <input type="text" id="inputBox_clipToWorld2">
                                <input type="text" id="inputBox_clipToWorld3">
                                <br>
                                <input type="text" id="inputBox_clipToWorld4">
                                <input type="text" id="inputBox_clipToWorld5">
                                <input type="text" id="inputBox_clipToWorld6">
                                <input type="text" id="inputBox_clipToWorld7">
                                <br>
                                <input type="text" id="inputBox_clipToWorld8">
                                <input type="text" id="inputBox_clipToWorld9">
                                <input type="text" id="inputBox_clipToWorld10">
                                <input type="text" id="inputBox_clipToWorld11">
                                <br>
                                <input type="text" id="inputBox_clipToWorld12">
                                <input type="text" id="inputBox_clipToWorld13">
                                <input type="text" id="inputBox_clipToWorld14">
                                <input type="text" id="inputBox_clipToWorld15">
                            </td>
                        </tr>
                        <tr>
                            <td valign="top">cameraPos&nbsp;</td>
                            <td>
                                <input type="text" id="inputBox_cameraPos0">
                                <input type="text" id="inputBox_cameraPos1">
                                <input type="text" id="inputBox_cameraPos2">
                            </td>
                        </tr>
                        <tr>
                            <td valign="top"><div class="tooltip">depthNearPlane&nbsp;<span class="tooltiptext">The depth value for the near plane.</span></div></td>
                            <td>
                                <input type="text" id="inputBox_depthNearPlane">
                            </td>
                        </tr>
                    </table>
                    <br><br>
                    <button type="button" class="collapsible">Internal Variables</button>
                    <table cellspacing="0" cellpadding="0" class="collapsiblecontent" style="display:none">
                        <tr>
                            <td valign="top">_dispatchSize_A_TwoRayGens1&nbsp;</td>
                            <td>
                                <input type="text" id="inputBox__dispatchSize_A_TwoRayGens10">
                                <input type="text" id="inputBox__dispatchSize_A_TwoRayGens11">
                                <input type="text" id="inputBox__dispatchSize_A_TwoRayGens12">
                            </td>
                        </tr>
                        <tr>
                            <td valign="top">_dispatchSize_B_TwoRayGens2&nbsp;</td>
                            <td>
                                <input type="text" id="inputBox__dispatchSize_B_TwoRayGens20">
                                <input type="text" id="inputBox__dispatchSize_B_TwoRayGens21">
                                <input type="text" id="inputBox__dispatchSize_B_TwoRayGens22">
                            </td>
                        </tr>
                    </table>
                    <br><br>
                    <button type="button" id="ResetVariables">Reset Variables</button>
                    <br/>
                    <br/>
                    <button type="button" class="collapsible">Imported Resources</button>
                    <table cellspacing="0" cellpadding="0" class="collapsiblecontent" style="display:block">
                        <tr><td>Texture URL: BlueChannel&nbsp;</td><td><input type="text" id="importedResourceURL_BlueChannel"></td></tr>
                    </table>
                    <br><br>

                    <button type=button class="collapsible">Camera</button>
                    <table cellspacing=0 cellpadding=0 class="collapsiblecontent" style="display:none">
                        <tr>
                            <td>Camera Pos</td>
                            <td>
                                <input type="text" id="CameraPos0" />
                                <input type="text" id="CameraPos1" />
                                <input type="text" id="CameraPos2" />
                            </td>
                        </tr>
                        <tr>
                            <td>Altitude Azimuth</td>
                            <td>
                                <input type="text" id="CameraAltitudeAzimuth0" />
                                <input type="text" id="CameraAltitudeAzimuth1" />
                            </td>
                        </tr>
                        <tr>
                            <td>&nbsp;</td>
                            <td>&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Mouse Sensitivity</td>
                            <td><input type="text" id="CameraMouseSensitivity" /></td>
                        </tr>
                        <tr>
                            <td>Fly Speed</td>
                            <td><input type="text" id="CameraFlySpeed" /></td>
                        </tr>
                        <tr>
                            <td colspan="2"><br /><button type="button" id="ResetCamera">Reset Camera</button><br /></td>
                        </tr>
                    </table>
                    <br/><br/>
                    <button type=button class="collapsible">Loading</button>
                    <table cellspacing=0 cellpadding=0 class="collapsiblecontent" style="display:block">
                        <tr>
                            <td><span id="LoadingText"></span></td>
                        </tr>
                    </table>
                    <span id="FPS"></span>
                    <br />
                    <br />
                    <b>Created using <a href="https://github.com/electronicarts/gigi/">Gigi v1.01.7</a></b>
                </td>
            </tr>
        </table>
    </body>
</html>